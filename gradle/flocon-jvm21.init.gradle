/**
 * Init script to configure JVM 21 target for all Kotlin compilations.
 * This ensures the Flocon submodule compiles with Java 21 bytecode,
 * which is required for IntelliJ Platform 2024.3 compatibility.
 */

allprojects {
    afterEvaluate { project ->
        // Configure Kotlin JVM target using task properties (works across classloaders)
        project.tasks.configureEach { task ->
            if (task.class.name.contains('KotlinCompile') || task.class.name.contains('KotlinJvmCompile')) {
                // Use Groovy's dynamic property access
                if (task.hasProperty('compilerOptions')) {
                    def options = task.compilerOptions
                    if (options.hasProperty('jvmTarget')) {
                        // Find JVM_21 enum value dynamically
                        def jvmTargetClass = options.jvmTarget.get().class
                        def jvm21 = jvmTargetClass.enumConstants.find { it.name() == 'JVM_21' }
                        if (jvm21 != null) {
                            options.jvmTarget.set(jvm21)
                        }
                    }
                }
            }
        }
        // Configure Java compatibility
        project.tasks.withType(JavaCompile).configureEach { task ->
            task.sourceCompatibility = '21'
            task.targetCompatibility = '21'
        }
    }
}
